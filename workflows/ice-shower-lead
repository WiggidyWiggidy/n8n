{
  "name": "My workflow 2",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "klaviyo-lead",
        "options": {}
      },
      "name": "Webhook (Klaviyo Listâ€‘Join)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "3b517011-b742-4a46-8a5c-f65f1fd78dd7",
      "webhookId": "26e5f75f-c8a4-4c7e-ace8-51d050887a76"
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "email",
              "value": "={{ $json[\"profile.email\"] }}"
            },
            {
              "name": "first_name",
              "value": "={{ $json[\"profile.first_name\"] }}"
            },
            {
              "name": "primary_struggle",
              "value": "={{ $json[\"biggest_struggle\"] }}"
            },
            {
              "name": "current_solution",
              "value": "={{ $json[\"current_solution\"] }}"
            },
            {
              "name": "urgency_label",
              "value": "={{ $json[\"importance_to_resolve\"] }}"
            },
            {
              "name": "postcode",
              "value": "={{ $json[\"profile.$address1.postal_code\"] }}"
            }
          ]
        },
        "options": {}
      },
      "name": "SetÂ LeadÂ Fields",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        240,
        0
      ],
      "id": "498c076e-2410-435e-bae1-a81b8fe7b8ac"
    },
    {
      "parameters": {
        "operation": "lookup",
        "documentId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        }
      },
      "name": "GoogleÂ SheetsÂ LookupÂ (Enrich)",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        528,
        0
      ],
      "id": "d61f73da-6ba6-432c-b4c2-5376d5226dc2"
    },
    {
      "parameters": {
        "functionCode": "\n                    // Build ChatGPT prompt\n                    const urgencyMap = {\n                      not_important: 1,\n                      somewhat_important: 3,\n                      very_important: 5\n                    };\n                    const item = items[0];\n                    const uScore = urgencyMap[item.json.urgency_label] || 3;\n                    item.json.prompt = `\nWrite a 320â€‘word, doubleâ€‘spaced persuasive report for ${item.json.first_name} (${item.json.postcode}).\n\nThey struggle with **${item.json.primary_struggle}** and currently rely on **${item.json.current_solution}**. Urgency level: **${item.json.urgency_label}**.\n\nLocal tap water = ${item.json.water_temp}Â°C (chemicals: ${item.json.chemicals}Â ppm). Coffee nearby costs $${item.json.coffee_price}/day.\n\nStructure:\n1. Empathyâ€‘packed opener linking to ${item.json.primary_struggle}.\n2. Quick science nugget on how cold exposure superâ€‘charges cognition.\n3. Bulletâ€‘list benefit stack: âš¡ instant energy, ðŸŽ¯ laser focus, ðŸ’° yearly savings vs. ${item.json.current_solution}, ðŸš¿ cleaner filtered water.\n4. \"Water Quality Reveal\" â€“ highlight ${item.json.chemicals}Â ppm and tease Everestâ€™s tripleâ€‘filter that removes them.\n5. \"30â€‘Second Everest Ice Shower\" challenge for tomorrow morning.\n6. Soft CTA: promise a private link to earlyâ€‘bird pricing inside the PDF.\n7. Playful signâ€‘off.\n                    `;\n                    return items;\n"
      },
      "name": "FunctionÂ â†’Â BuildÂ Prompt",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        800,
        0
      ],
      "id": "49893f8a-b4f6-41ce-8e2f-bb7acde53d42"
    },
    {
      "parameters": {},
      "name": "OpenAIÂ ChatÂ Completion",
      "type": "n8n-nodes-base.openai",
      "typeVersion": 1,
      "position": [
        1040,
        0
      ],
      "id": "4d891c3b-a937-49c3-97b8-580b933aaffc",
      "credentials": {}
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://api.pdfmonkey.io/v1/documents",
        "jsonParameters": true,
        "options": {}
      },
      "name": "HTTPÂ â†’Â PDFMonkey",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1280,
        0
      ],
      "id": "f00a4b6c-0c98-4d28-b262-f3c595e3fdea"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://a.klaviyo.com/api/v1/email/send",
        "jsonParameters": true,
        "options": {}
      },
      "name": "HTTPÂ â†’Â SendÂ KlaviyoÂ Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1520,
        0
      ],
      "id": "2b03bd53-9af3-4050-9a55-abf4ef77f1cc"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": ""
        }
      },
      "name": "GoogleÂ SheetsÂ AppendÂ Log",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        1760,
        0
      ],
      "id": "2cf2f0d6-ce73-437d-8587-2a9ad6e83f16"
    },
    {
      "parameters": {
        "url": "YOUR_SLACK_WEBHOOK_URL",
        "jsonParameters": true,
        "options": {}
      },
      "name": "HTTPÂ â†’Â SlackÂ Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1280,
        240
      ],
      "id": "89b2854d-ef17-4d04-a5e2-603303eb91ac"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook (Klaviyo Listâ€‘Join)": {
      "main": [
        [
          {
            "node": "SetÂ LeadÂ Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SetÂ LeadÂ Fields": {
      "main": [
        [
          {
            "node": "GoogleÂ SheetsÂ LookupÂ (Enrich)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GoogleÂ SheetsÂ LookupÂ (Enrich)": {
      "main": [
        [
          {
            "node": "FunctionÂ â†’Â BuildÂ Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTPÂ â†’Â PDFMonkey": {
      "main": [
        [
          {
            "node": "HTTPÂ â†’Â SendÂ KlaviyoÂ Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTPÂ â†’Â SendÂ KlaviyoÂ Email": {
      "main": [
        [
          {
            "node": "GoogleÂ SheetsÂ AppendÂ Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "",
  "meta": {
    "instanceId": "2e0382691239745fd64be93abb3badde65be8bcefa6fa437c542a641167ac57f"
  },
  "tags": []
}
